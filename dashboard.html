<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - EcoTrace</title>
  <link rel="icon" type="image/png" href="/imagens/image-removebg-preview (1).png">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="css/dash.css"
</head>
<body>
  <!-- Botão Menu Mobile -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
</button>

<!-- Overlay para fechar menu -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- MENU LATERAL -->

<aside class="sidebar">
  <div class="logo-container">
   <a href="index.html"> <img id="logo" src="/imagens/cin.png" alt="EcoTrace" class="logo"> </a>
  </div>
  
  <div class="user-info">
    <div class="user-avatar">
      <i class="fas fa-user-circle"></i>
    </div>
    <div class="user-details">
      <span class="user-name" id="nome-usuario-sidebar">Carregando...</span>
      <span class="user-role">Administrador</span>
    </div>
  </div>
  
  <nav class="menu">
    <button id="dashboard-home" class="menu-btn active">
      <i class="fas fa-chart-pie"></i>
      <span>Dashboard</span>
    </button>
    
    <button id="users-btn" class="menu-btn">
      <i class="fas fa-users"></i>
      <span>Usuários</span>
    </button>
    
    <button id="reports-btn" class="menu-btn">
      <i class="fas fa-file-alt"></i>
      <span>Relatórios</span>
    </button>

    <!-- Após o botão de Relatórios -->
<button id="waste-btn" class="menu-btn">
  <i class="fas fa-recycle"></i>
  <span>Rastreamento</span>
</button>
    
    <div class="menu-divider"></div>
    
    <a href="forms.html" class="menu-btn link-btn">
      <i class="fas fa-plus-circle"></i>
      <span>Novo</span>
    </a>

     <a href="downloads.html" class="menu-btn link-btn">
      <i class="fas fa-download"></i>

      <span>Downloads</span>
    </a>
    
    <div class="menu-footer">
      <button id="logout-btn" class="menu-btn logout">
        <i class="fas fa-sign-out-alt"></i>
        <span>Sair</span>
      </button>
    </div>
  </nav>
</aside>

<!-- CONTEÚDO PRINCIPAL -->
<main class="main-content">
  <!-- HEADER -->
  <header class="main-header">
    <div class="header-left">
      <h1>Dashboard EcoTrace</h1>
      <p class="subtitle">Sistema de Monitoramento de Sustentabilidade</p>
    </div>
    
    <div class="header-right">
      <div class="date-display">
        <i class="fas fa-calendar-alt"></i>
        <span id="current-date"></span>
      </div>
    </div>
  </header>

  <!-- DASHBOARD -->
  <section id="home-card" class="card active">
    <div class="card-header">
      <h2><i class="fas fa-tachometer-alt"></i> Visão Geral</h2>
      <div class="card-actions">
        <button class="btn-icon" id="refresh-data" title="Atualizar">
          <i class="fas fa-redo"></i>
        </button>
      </div>
    </div>
    
    <!-- KPI CARDS -->
    <div class="kpis-grid">
      <div class="kpi-card primary">
        <div class="kpi-icon">
          <i class="fas fa-clipboard-list"></i>
        </div>
        <div class="kpi-content">
          <h3>Total de Diagnósticos</h3>
          <span id="kpi-total" class="kpi-value">0</span>
        </div>
      </div>
      
      <div class="kpi-card success">
        <div class="kpi-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="kpi-content">
          <h3>Média Geral</h3>
          <span id="kpi-media" class="kpi-value">0%</span>
        </div>
      </div>
      
      <div class="kpi-card warning">
        <div class="kpi-icon">
          <i class="fas fa-star"></i>
        </div>
        <div class="kpi-content">
          <h3>Categoria Mais Comum</h3>
          <span id="kpi-categoria" class="kpi-value">-</span>
        </div>
      </div>
    </div>
    
    <!-- CHARTS -->
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-header">
          <h3><i class="fas fa-chart-pie"></i> Distribuição</h3>
        </div>
        <div class="chart-wrapper">
          <canvas id="chart-categorias"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <h3><i class="fas fa-chart-line"></i> Médias</h3>
        </div>
        <div class="chart-wrapper">
          <canvas id="chart-medias"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- USUÁRIOS -->
  <section id="users-card" class="card">
    <div class="card-header">
      <h2><i class="fas fa-users"></i> Gerenciar Usuários</h2>
    </div>
    
    <div class="table-container">
      <table id="users-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Email</th>
            <th>Permissão</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="users-tbody">
          <tr class="loading-row">
            <td colspan="4">
              <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Carregando usuários...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- RELATÓRIOS -->
  <section id="reports-card" class="card">
    <div class="card-header">
      <h2><i class="fas fa-file-alt"></i> Relatórios</h2>
      <div class="card-actions">
        <button class="btn-primary" id="export-pdf">
          <i class="fas fa-download"></i> Exportar CSV
        </button>
      </div>
    </div>
    
    <div class="table-container">
      <table id="reports-table">
        <thead>
          <tr>
            <th>Empresa</th>
            <th>Data</th>
            <th>Pontuação</th>
            <th>Categoria</th>
          </tr>
        </thead>
        <tbody id="reports-tbody">
          <tr class="loading-row">
            <td colspan="4">
              <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Carregando relatórios...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- RASTREAMENTO DE RESÍDUOS -->
<section id="waste-card" class="card">
  <div class="card-header">
    <h2><i class="fas fa-recycle"></i> Rastreamento de Resíduos Industriais</h2>
    <div class="card-actions">
      <button class="btn-primary" id="simulate-tracking">
        <i class="fas fa-play"></i> Simular Rastreamento
      </button>
      <button class="btn-secondary" id="generate-waste-report">
        <i class="fas fa-file-pdf"></i> Gerar Relatório
      </button>
    </div>
  </div>

  <!-- FILTROS E CONTROLES -->
  <div class="waste-controls">
    <div class="filter-group">
      <div class="filter-item">
        <label for="waste-type"><i class="fas fa-filter"></i> Tipo de Resíduo</label>
        <select id="waste-type" class="select-filter">
          <option value="all">Todos os tipos</option>
          <option value="solid">Sólido</option>
          <option value="liquid">Líquido</option>
          <option value="hazardous">Perigoso</option>
          <option value="organic">Orgânico</option>
          <option value="recyclable">Reciclável</option>
        </select>
      </div>
      
      <div class="filter-item">
        <label for="waste-status"><i class="fas fa-traffic-light"></i> Status</label>
        <select id="waste-status" class="select-filter">
          <option value="all">Todos os status</option>
          <option value="generated">Gerado</option>
          <option value="in_transport">Em Transporte</option>
          <option value="processing">Em Processamento</option>
          <option value="disposed">Destinado</option>
          <option value="recycled">Reciclado</option>
        </select>
      </div>
      
      <div class="filter-item">
        <label for="date-range"><i class="fas fa-calendar"></i> Período</label>
        <select id="date-range" class="select-filter">
          <option value="today">Hoje</option>
          <option value="week">Última semana</option>
          <option value="month" selected>Último mês</option>
          <option value="quarter">Último trimestre</option>
          <option value="year">Último ano</option>
        </select>
      </div>
    </div>
    
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="waste-search" placeholder="Buscar por ID, empresa ou material...">
    </div>
  </div>

  <!-- MAPA DE RASTREAMENTO -->
  <div class="waste-map-container">
    <h3><i class="fas fa-map-marked-alt"></i> Mapa de Rastreamento em Tempo Real</h3>
    <div class="waste-map" id="waste-map">
      <!-- Pontos no mapa -->
      <div class="map-point" style="top: 20%; left: 25%;" data-status="generated">
        <div class="point-pulse"></div>
        <div class="point-tooltip">Ind. Metalúrgica A</div>
      </div>
      <div class="map-point" style="top: 45%; left: 40%;" data-status="in_transport">
        <div class="point-pulse"></div>
        <div class="point-tooltip">Transporte em andamento</div>
      </div>
      <div class="map-point" style="top: 60%; left: 65%;" data-status="processing">
        <div class="point-pulse"></div>
        <div class="point-tooltip">Centro de Reciclagem</div>
      </div>
      <div class="map-point" style="top: 75%; left: 80%;" data-status="disposed">
        <div class="point-pulse"></div>
        <div class="point-tooltip">Aterro Sanitário</div>
      </div>
      
      <!-- Rotas -->
      <div class="map-route route-1"></div>
      <div class="map-route route-2"></div>
      <div class="map-route route-3"></div>
      
      <!-- Legenda -->
      <div class="map-legend">
        <div class="legend-item">
          <span class="legend-color status-generated"></span>
          <span>Gerado</span>
        </div>
        <div class="legend-item">
          <span class="legend-color status-in_transport"></span>
          <span>Em Transporte</span>
        </div>
        <div class="legend-item">
          <span class="legend-color status-processing"></span>
          <span>Processamento</span>
        </div>
        <div class="legend-item">
          <span class="legend-color status-disposed"></span>
          <span>Destinado</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ESTATÍSTICAS EM TEMPO REAL -->
  <div class="waste-stats-grid">
    <div class="waste-stat-card">
      <div class="stat-icon">
        <i class="fas fa-weight-hanging"></i>
      </div>
      <div class="stat-content">
        <h4>Total Monitorado</h4>
        <span class="stat-value" id="total-waste">1,245.8</span>
        <span class="stat-unit">toneladas</span>
        <div class="stat-trend positive">
          <i class="fas fa-arrow-up"></i>
          <span>12% vs mês anterior</span>
        </div>
      </div>
    </div>
    
    <div class="waste-stat-card">
      <div class="stat-icon">
        <i class="fas fa-recycle"></i>
      </div>
      <div class="stat-content">
        <h4>Taxa de Reciclagem</h4>
        <span class="stat-value" id="recycling-rate">67.3</span>
        <span class="stat-unit">%</span>
        <div class="stat-trend positive">
          <i class="fas fa-arrow-up"></i>
          <span>8.2% vs mês anterior</span>
        </div>
      </div>
    </div>
    
    <div class="waste-stat-card">
      <div class="stat-icon">
        <i class="fas fa-truck"></i>
      </div>
      <div class="stat-content">
        <h4>Em Transporte</h4>
        <span class="stat-value" id="in-transport">42</span>
        <span class="stat-unit">cargas</span>
        <div class="stat-trend neutral">
          <i class="fas fa-minus"></i>
          <span>Estável</span>
        </div>
      </div>
    </div>
    
    <div class="waste-stat-card">
      <div class="stat-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="stat-content">
        <h4>Resíduos Perigosos</h4>
        <span class="stat-value" id="hazardous-waste">78.5</span>
        <span class="stat-unit">toneladas</span>
        <div class="stat-trend negative">
          <i class="fas fa-arrow-down"></i>
          <span>15% vs mês anterior</span>
        </div>
      </div>
    </div>
  </div>

  <!-- LISTA DE RESÍDUOS EM TEMPO REAL -->
  <div class="table-container">
    <table id="waste-table">
      <thead>
        <tr>
          <th>ID do Rastreio</th>
          <th>Empresa Geradora</th>
          <th>Tipo de Resíduo</th>
          <th>Quantidade</th>
          <th>Status</th>
          <th>Localização Atual</th>
          <th>Última Atualização</th>
        </tr>
      </thead>
      <tbody id="waste-tbody">
        <!-- Dados serão carregados via JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- TIMELINE DE PROCESSAMENTO -->
  <div class="waste-timeline">
    <h3><i class="fas fa-history"></i> Timeline do Processamento</h3>
    <div class="timeline-container">
      <div class="timeline-item completed">
        <div class="timeline-icon">
          <i class="fas fa-industry"></i>
        </div>
        <div class="timeline-content">
          <h4>Geração do Resíduo</h4>
          <p>Indústria Metalúrgica ABC</p>
          <span class="timeline-time">08:30 AM • Hoje</span>
        </div>
      </div>
      
      <div class="timeline-item active">
        <div class="timeline-icon">
          <i class="fas fa-truck-loading"></i>
        </div>
        <div class="timeline-content">
          <h4>Coleta e Carregamento</h4>
          <p>Transportadora VerdeLog</p>
          <span class="timeline-time">10:15 AM • Em andamento</span>
        </div>
      </div>
      
      <div class="timeline-item pending">
        <div class="timeline-icon">
          <i class="fas fa-road"></i>
        </div>
        <div class="timeline-content">
          <h4>Transporte</h4>
          <p>Em trânsito para centro de reciclagem</p>
          <span class="timeline-time">Estimado: 11:30 AM</span>
        </div>
      </div>
      
      <div class="timeline-item pending">
        <div class="timeline-icon">
          <i class="fas fa-recycle"></i>
        </div>
        <div class="timeline-content">
          <h4>Processamento</h4>
          <p>Centro de Reciclagem Sustentável</p>
          <span class="timeline-time">Estimado: 2:00 PM</span>
        </div>
      </div>
    </div>
  </div>
</section>
</main>


<!-- NOTIFICAÇÃO -->
<div class="notificacao" id="notificacao" aria-live="polite">
  <i class="fas fa-check-circle"></i>
  <span class="notif-text"></span>
</div>

<!-- SCRIPT -->
<script type="module">
// Configurações (mantenha os seus valores)
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAe7mU1MyCwrBmJlm89cKM-WHONzeqyU3w",
    authDomain: "projeto-ecotrace.firebaseapp.com",
    projectId: "projeto-ecotrace",
    storageBucket: "projeto-ecotrace.firebasestorage.app",
    messagingSenderId: "528782336744",
    appId: "1:528782336744:web:1f4b1fa4807543ff225f5d",
    measurementId: "G-RTWLGJD188"
};

// Importações Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

// Inicializar Firebase
const app = initializeApp(FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getFirestore(app);

// Variáveis globais
let charts = {};
let currentUser = null;

// Elementos DOM
const elements = {
    userSidebar: document.getElementById('nome-usuario-sidebar'),
    currentDate: document.getElementById('current-date'),
    notificacao: document.getElementById('notificacao'),
    notifText: document.querySelector('.notif-text'),
    notifIcon: document.querySelector('#notificacao i'),
    kpiTotal: document.getElementById('kpi-total'),
    kpiMedia: document.getElementById('kpi-media'),
    kpiCategoria: document.getElementById('kpi-categoria'),
    usersTbody: document.getElementById('users-tbody'),
    reportsTbody: document.getElementById('reports-tbody')
};

// Inicialização
function init() {
    setupEventListeners();
    updateCurrentDate();
    setInterval(updateCurrentDate, 60000);
    setupAuth();
}

// Configurar Event Listeners
function setupEventListeners() {
    // Navegação
    document.getElementById('dashboard-home').addEventListener('click', () => showSection('home-card'));
    document.getElementById('users-btn').addEventListener('click', () => showSection('users-card'));
    document.getElementById('reports-btn').addEventListener('click', () => showSection('reports-card'));
    
    // Botões de ação
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    document.getElementById('refresh-data').addEventListener('click', refreshAllData);
    document.getElementById('export-pdf').addEventListener('click', exportReports);
    document.getElementById('waste-btn').addEventListener('click', () => showSection('waste-card'));
}

// Autenticação
function setupAuth() {
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "index.html";
            return;
        }
        
        currentUser = user;
        elements.userSidebar.textContent = user.displayName || (user.email ? user.email.split('@')[0] : 'Usuário');
        showNotification(`Bem-vindo, ${elements.userSidebar.textContent}!`, 'success');
        
        // Carregar dados iniciais
        await Promise.all([
            loadDashboardData(),
            loadUsers(),
            loadReports()
        ]);
    });
}

// Funções de utilidade
function updateCurrentDate() {
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    elements.currentDate.textContent = now.toLocaleDateString('pt-BR', options);
}

let notifTimeout = null;
function showNotification(message, type = 'info', duration = 3000) {
    elements.notifText.textContent = message;
    elements.notificacao.className = `notificacao show ${type}`;
    elements.notifIcon.className = type === 'success' ? 'fas fa-check-circle' :
                                  type === 'error' ? 'fas fa-exclamation-circle' :
                                  'fas fa-info-circle';
    if (notifTimeout) clearTimeout(notifTimeout);
    notifTimeout = setTimeout(() => {
        elements.notificacao.classList.remove('show');
    }, duration);
}

function showSection(sectionId) {
    // Atualizar menu
    document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
    const btnMap = {
        'home-card': 'dashboard-home',
        'users-card': 'users-btn',
        'reports-card': 'reports-btn'
    };
    if (btnMap[sectionId]) {
        const el = document.getElementById(btnMap[sectionId]);
        if (el) el.classList.add('active');
    }
    
    // Mostrar seção
    document.querySelectorAll('.card').forEach(card => card.classList.remove('active'));
    const target = document.getElementById(sectionId);
    if (target) target.classList.add('active');
}

// Funções de dados
async function refreshAllData() {
    showNotification('Atualizando dados...', 'info', 5000);
    try {
        await Promise.all([
            loadDashboardData(),
            loadUsers(),
            loadReports()
        ]);
        showNotification('Dados atualizados!', 'success');
    } catch (error) {
        showNotification('Erro ao atualizar dados', 'error');
        console.error(error);
    }
}

async function loadDashboardData() {
    try {
        const snapshot = await getDocs(collection(db, "diagnosticos"));
        
        // Inicializar contadores
        const categories = {
            "Líder": { count: 0, scores: [] },
            "Avançado": { count: 0, scores: [] },
            "Transição": { count: 0, scores: [] },
            "Iniciante": { count: 0, scores: [] },
            "Atenção": { count: 0, scores: [] }
        };
        
        let total = 0;
        let totalScore = 0;
        
        // Processar dados
        snapshot.forEach(docSnap => {
            const data = docSnap.data ? docSnap.data() : {};
            const score = Number(data.pontuacao ?? 0);
            
            total++;
            totalScore += score;
            
            // Categorizar
            if (score >= 90) {
                categories["Líder"].count++;
                categories["Líder"].scores.push(score);
            } else if (score >= 75) {
                categories["Avançado"].count++;
                categories["Avançado"].scores.push(score);
            } else if (score >= 60) {
                categories["Transição"].count++;
                categories["Transição"].scores.push(score);
            } else if (score >= 40) {
                categories["Iniciante"].count++;
                categories["Iniciante"].scores.push(score);
            } else {
                categories["Atenção"].count++;
                categories["Atenção"].scores.push(score);
            }
        });
        
        // Atualizar KPIs
        const average = total > 0 ? (totalScore / total) : 0;
        const averageRounded = average ? average.toFixed(1) : 0;
        const mostCommon = total > 0 ? Object.entries(categories)
            .sort((a, b) => b[1].count - a[1].count)[0][0] : '-';
        
        elements.kpiTotal.textContent = total;
        elements.kpiMedia.textContent = `${averageRounded}%`;
        elements.kpiCategoria.textContent = mostCommon;
        
        // Criar/atualizar gráficos
        createCharts(categories);
        
    } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
        showNotification('Erro ao carregar dados do dashboard', 'error');
    }
}

function createCharts(categories) {
    // Destruir gráficos existentes
    Object.values(charts).forEach(chart => chart && chart.destroy());
    charts = {};
    
    // Map de cores alinhado às labels
    const colorMap = {
        "Líder": '#4caf50',
        "Avançado": '#2196f3',
        "Transição": '#ff9800',
        "Iniciante": '#f44336',
        "Atenção": '#9c27b0'
    };
    
    const labels = Object.keys(categories);
    const counts = labels.map(lbl => categories[lbl].count);
    const averages = labels.map(lbl => {
        const scores = categories[lbl].scores;
        return scores.length ? (scores.reduce((a,b) => a + b, 0) / scores.length) : 0;
    }).map(v => Number(v.toFixed(1)));
    
    try {
        // Pizza - distribuição
        const ctxPie = document.getElementById('chart-categorias').getContext('2d');
        charts.pie = new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels,
                datasets: [{
                    data: counts,
                    backgroundColor: labels.map(l => colorMap[l]),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#c7d8f2', padding: 20 } }
                }
            }
        });
    } catch (err) {
        console.error('Erro criando gráfico de pizza:', err);
    }
    
    try {
        // Linha - médias
        const ctxLine = document.getElementById('chart-medias').getContext('2d');
        charts.line = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Média por Categoria',
                    data: averages,
                    borderColor: '#24df37',
                    backgroundColor: 'rgba(36, 223, 55, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { callback: v => v + '%' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    } catch (err) {
        console.error('Erro criando gráfico de médias:', err);
    }
}

async function loadUsers() {
    const tbody = elements.usersTbody;
    tbody.innerHTML = '<tr class="loading-row"><td colspan="4">Carregando...</td></tr>';
    
    try {
        const snapshot = await getDocs(collection(db, "usuarios"));
        
        if (snapshot.empty) {
            tbody.innerHTML = '<tr class="empty-state"><td colspan="4">Nenhum usuário encontrado</td></tr>';
            return;
        }
        
        let html = '';
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const id = docSnap.id;
            const isAdmin = data.role === 'admin';
            const safeName = escapeHtml(data.nome || 'Sem nome');
            const safeEmail = escapeHtml(data.email || '');
            
            html += `
                <tr>
                    <td>${safeName}</td>
                    <td>${safeEmail}</td>
                    <td><span class="badge ${isAdmin ? 'badge-admin' : 'badge-user'}">${escapeHtml(data.role || 'user')}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn ${isAdmin ? 'demote-btn' : 'promote-btn'}" 
                                    data-userid="${id}" data-isadmin="${isAdmin}">
                                <i class="fas fa-${isAdmin ? 'arrow-down' : 'arrow-up'}"></i>
                            </button>
                            <button class="action-btn delete-btn" data-userid-delete="${id}" data-user-email="${safeEmail}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
        
        // Delegação de eventos (melhor que inline onclick)
        tbody.querySelectorAll('[data-userid]').forEach(btn => {
            btn.onclick = () => {
                const userId = btn.getAttribute('data-userid');
                const isAdmin = btn.getAttribute('data-isadmin') === 'true';
                toggleUserRole(userId, isAdmin);
            };
        });
        tbody.querySelectorAll('[data-userid-delete]').forEach(btn => {
            btn.onclick = () => {
                const userId = btn.getAttribute('data-userid-delete');
                const userEmail = btn.getAttribute('data-user-email');
                deleteUser(userId, userEmail);
            };
        });
        
    } catch (error) {
        console.error('Erro ao carregar usuários:', error);
        tbody.innerHTML = '<tr class="error-state"><td colspan="4">Erro ao carregar usuários</td></tr>';
    }
}

async function loadReports() {
    const tbody = elements.reportsTbody;
    tbody.innerHTML = '<tr class="loading-row"><td colspan="4">Carregando...</td></tr>';
    
    try {
        // Ordenar por data, se existir
        const q = query(collection(db, "diagnosticos"), /* orderBy('data', 'desc') */);
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            tbody.innerHTML = '<tr class="empty-state"><td colspan="4">Nenhum relatório encontrado</td></tr>';
            return;
        }
        
        let html = '';
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const score = Number(data.pontuacao ?? 0);
            
            // Determinar categoria
            let category = 'Atenção';
            let badgeClass = 'badge-atencao';
            if (score >= 90) { category = 'Líder'; badgeClass = 'badge-lider'; }
            else if (score >= 75) { category = 'Avançado'; badgeClass = 'badge-avancado'; }
            else if (score >= 60) { category = 'Transição'; badgeClass = 'badge-transicao'; }
            else if (score >= 40) { category = 'Iniciante'; badgeClass = 'badge-iniciante'; }
            
            // Formatar data robustamente
            let formattedDate = 'N/A';
            if (data.data) {
                // Se for Timestamp do Firestore
                if (data.data.seconds !== undefined) {
                    formattedDate = new Date(data.data.seconds * 1000).toLocaleDateString('pt-BR');
                } else {
                    // Tenta parse como string ou número
                    const d = new Date(data.data);
                    if (!isNaN(d)) formattedDate = d.toLocaleDateString('pt-BR');
                    else formattedDate = String(data.data);
                }
            }
            
            html += `
                <tr>
                    <td>${escapeHtml(data.empresa || 'Não informado')}</td>
                    <td>${formattedDate}</td>
                    <td>${score}%</td>
                    <td><span class="badge ${badgeClass}">${category}</span></td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
        
    } catch (error) {
        console.error('Erro ao carregar relatórios:', error);
        tbody.innerHTML = '<tr class="error-state"><td colspan="4">Erro ao carregar relatórios</td></tr>';
    }
}

// Funções de ação (anexadas ao escopo global via window onde necessário)
window.toggleUserRole = async function(userId, isAdmin) {
    if (!confirm(`Tem certeza que deseja ${isAdmin ? 'rebaixar' : 'promover'} este usuário?`)) return;
    
    try {
        const newRole = isAdmin ? 'user' : 'admin';
        await updateDoc(doc(db, "usuarios", userId), { role: newRole });
        showNotification(`Usuário ${isAdmin ? 'rebaixado' : 'promovido'} com sucesso!`, 'success');
        loadUsers();
    } catch (error) {
        showNotification('Erro ao alterar permissão', 'error');
        console.error(error);
    }
};

window.deleteUser = async function(userId, userEmail) {
    if (!confirm(`Tem certeza que deseja excluir o usuário ${userEmail}?`)) return;
    
    try {
        await deleteDoc(doc(db, "usuarios", userId));
        showNotification('Usuário excluído com sucesso!', 'success');
        loadUsers();
    } catch (error) {
        showNotification('Erro ao excluir usuário', 'error');
        console.error(error);
    }
};

async function handleLogout() {
    try {
        await signOut(auth);
        showNotification('Logout realizado com sucesso!', 'success', 1000);
        setTimeout(() => window.location.href = "index.html", 1000);
    } catch (error) {
        showNotification('Erro ao fazer logout', 'error');
    }
}

// Exportar relatórios -> gera CSV e baixa
async function exportReports() {
    showNotification('Gerando CSV...', 'info');
    try {
        const snapshot = await getDocs(collection(db, "diagnosticos"));
        if (snapshot.empty) {
            showNotification('Nenhum relatório para exportar', 'error');
            return;
        }
        const rows = [];
        rows.push(['Empresa', 'Data', 'Pontuação', 'Categoria']);
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const score = Number(data.pontuacao ?? 0);
            let category = 'Atenção';
            if (score >= 90) category = 'Líder';
            else if (score >= 75) category = 'Avançado';
            else if (score >= 60) category = 'Transição';
            else if (score >= 40) category = 'Iniciante';
            
            let formattedDate = '';
            if (data.data) {
                if (data.data.seconds !== undefined) formattedDate = new Date(data.data.seconds * 1000).toLocaleDateString('pt-BR');
                else {
                    const d = new Date(data.data);
                    formattedDate = !isNaN(d) ? d.toLocaleDateString('pt-BR') : String(data.data);
                }
            }
            rows.push([data.empresa || '', formattedDate, `${score}%`, category]);
        });
        
        // Converter para CSV
        const csvContent = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `relatorios_ecotrace_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showNotification('CSV exportado com sucesso!', 'success');
    } catch (error) {
        console.error('Erro exportando relatórios:', error);
        showNotification('Erro ao exportar relatórios', 'error');
    }
}

// Utility: escape HTML para evitar injeção ao montar innerHTML
function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
}

// Inicializar aplicação
document.addEventListener('DOMContentLoaded', init);



// Adicionar evento para o botão do menu
document.getElementById('waste-btn').addEventListener('click', () => showSection('waste-card'));

// Dados simulados
const simulatedWasteData = [
  {
    id: "TRACK-2024-001",
    empresa: "Indústria Metalúrgica ABC",
    tipo: "Metálico",
    quantidade: "12.5 ton",
    status: "in_transport",
    localizacao: "Rodovia BR-101, km 45",
    atualizacao: "10:30 AM"
  },
  {
    id: "TRACK-2024-002",
    empresa: "Plásticos Sustentáveis SA",
    tipo: "Plástico",
    quantidade: "8.2 ton",
    status: "processing",
    localizacao: "Centro de Reciclagem Norte",
    atualizacao: "09:45 AM"
  },
  {
    id: "TRACK-2024-003",
    empresa: "Química Verde Ltda",
    tipo: "Químico",
    quantidade: "3.7 ton",
    status: "generated",
    localizacao: "Planta Industrial Zona Sul",
    atualizacao: "08:15 AM"
  },
  {
    id: "TRACK-2024-004",
    empresa: "Minerais do Vale",
    tipo: "Mineral",
    quantidade: "25.1 ton",
    status: "disposed",
    localizacao: "Aterro Sanitário Controlado",
    atualizacao: "Ontem, 16:20"
  },
  {
    id: "TRACK-2024-005",
    empresa: "Papel e Celulose XPTO",
    tipo: "Papelão",
    quantidade: "15.8 ton",
    status: "in_transport",
    localizacao: "Avenida Industrial, km 12",
    atualizacao: "10:00 AM"
  }
];

// Função para carregar dados simulados
function loadWasteTrackingData() {
  const tbody = document.getElementById('waste-tbody');
  if (!tbody) return;
  
  let html = '';
  simulatedWasteData.forEach(item => {
    const statusMap = {
      "generated": { text: "Gerado", class: "badge-warning" },
      "in_transport": { text: "Em Transporte", class: "badge-in_transport" },
      "processing": { text: "Processando", class: "badge-processing" },
      "disposed": { text: "Destinado", class: "badge-success" }
    };
    
    const status = statusMap[item.status] || { text: item.status, class: "" };
    
    html += `
      <tr>
        <td><strong>${item.id}</strong></td>
        <td>${item.empresa}</td>
        <td>
          <span class="badge ${getWasteTypeBadge(item.tipo)}">
            ${item.tipo}
          </span>
        </td>
        <td>${item.quantidade}</td>
        <td><span class="badge ${status.class}">${status.text}</span></td>
        <td>${item.localizacao}</td>
        <td>${item.atualizacao}</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function getWasteTypeBadge(type) {
  const badges = {
    "Metálico": "badge-warning",
    "Plástico": "badge-info",
    "Químico": "badge-danger",
    "Mineral": "badge-secondary",
    "Papelão": "badge-primary"
  };
  return badges[type] || "badge-secondary";
}

// Simulação de dados em tempo real
function simulateRealTimeUpdates() {
  // Atualizar contadores
  const totalElement = document.getElementById('total-waste');
  const recyclingElement = document.getElementById('recycling-rate');
  const transportElement = document.getElementById('in-transport');
  const hazardousElement = document.getElementById('hazardous-waste');
  
  if (totalElement) {
    const current = parseFloat(totalElement.textContent.replace(',', ''));
    totalElement.textContent = (current + (Math.random() * 0.5)).toFixed(1);
  }
  
  if (recyclingElement) {
    const current = parseFloat(recyclingElement.textContent);
    const change = (Math.random() * 0.3) - 0.15;
    recyclingElement.textContent = Math.max(0, Math.min(100, current + change)).toFixed(1);
  }
  
  if (transportElement) {
    const current = parseInt(transportElement.textContent);
    transportElement.textContent = Math.max(0, current + (Math.random() > 0.7 ? 1 : -1));
  }
  
  // Animar pontos no mapa
  document.querySelectorAll('.point-pulse').forEach(pulse => {
    pulse.style.animation = 'none';
    setTimeout(() => {
      pulse.style.animation = 'pulse 2s infinite';
    }, 10);
  });
}

// Event listeners para controles
document.getElementById('simulate-tracking')?.addEventListener('click', () => {
  simulateRealTimeUpdates();
  showNotification('Simulação de rastreamento iniciada!', 'success');
});

document.getElementById('generate-waste-report')?.addEventListener('click', () => {
  showNotification('Gerando relatório de resíduos...', 'info');
  setTimeout(() => {
    showNotification('Relatório gerado com sucesso!', 'success');
    // Simular download
    const link = document.createElement('a');
    link.href = '#';
    link.download = 'relatorio_residuos_ecotrace.pdf';
    link.click();
  }, 2000);
});

// Filtros
document.querySelectorAll('.select-filter').forEach(select => {
  select.addEventListener('change', () => {
    showNotification('Filtros aplicados com sucesso!', 'success');
  });
});

// Carregar dados iniciais quando a seção for ativada
document.addEventListener('DOMContentLoaded', () => {
  // Adicionar observer para detectar quando a seção de resíduos estiver ativa
  const wasteSection = document.getElementById('waste-card');
  if (wasteSection) {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class' && 
            wasteSection.classList.contains('active')) {
          loadWasteTrackingData();
          // Iniciar simulação em tempo real
          setInterval(simulateRealTimeUpdates, 5000);
        }
      });
    });
    
    observer.observe(wasteSection, { attributes: true });
  }
  
  // Carregar dados inicialmente se a seção já estiver ativa
  if (wasteSection?.classList.contains('active')) {
    loadWasteTrackingData();
    setInterval(simulateRealTimeUpdates, 5000);
  }
});
</script>


<script>

  // Controle do menu mobile
const mobileMenuToggle = document.getElementById('mobileMenuToggle');
const sidebar = document.querySelector('.sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');

if (mobileMenuToggle && sidebar && sidebarOverlay) {
    mobileMenuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
        sidebarOverlay.classList.toggle('active');
    });
    
    sidebarOverlay.addEventListener('click', () => {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
    });
    
    // Fechar menu ao clicar em um link
    document.querySelectorAll('.menu-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (window.innerWidth <= 991) {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            }
        });
    });
}
</script>
</body>
</html>
