<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Admin - EcoTrace</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- CSS Mega Blaster -->
<link rel="stylesheet" href="/css/dash.css">
</head>
<body>

<!-- MENU LATERAL FIXO -->
<aside class="sidebar">
  <div class="logo-container">  
    <img id="logo" src="/imagens/image-removebg-preview (1).png" alt="ecotrace" class="logo">  
  </div>
  <nav class="menu">
    <p>________</p>

 


    <button id="dashboard-home" class="menu-btn"><img class="icone" src="/imagens/graficos.png" alt="graph"></button>
    <button id="users-btn" class="menu-btn"><img class="icone" src="/imagens/perfilz.png" alt="login"></button>
    <button id="reports-btn" class="menu-btn"><img class="icone" src="/imagens/docs.png" alt="docs"></button>
     <p>________</p>
    <div id="ext">
    <a id="login" href="forms.html">
        <img class="icone" src="/imagens/log.png" alt="login">
      </a>
      
      <a id="downloads" href="downloads.html">
        <img class="icone" src="/imagens/down.png" alt="downloads">
      </a>
      <button id="logout-btn" class="menu-btn logout"><img class="icone-log" src="/imagens/logout.png" alt="docs"></button>
      </div>
    </nav>
  
</aside>

<!-- CONTEÚDO PRINCIPAL -->
<main class="main-content">
  <header>
    <h1>Bem-vindo, <span id="nome-usuario">Admin</span>!</h1>
    
  </header>

  <!-- HOME CARD -->
  <section id="home-card" class="card active">
    <h2>Visão Geral do Sistema</h2>
    <div class="kpis">
      <div class="kpi">
        <h3>Total de Diagnósticos</h3>
        <span id="kpi-total">0</span>
      </div>
      <div class="kpi">
        <h3>Média Geral</h3>
        <span id="kpi-media">0%</span>
      </div>
      <div class="kpi">
        <h3>Categoria mais comum</h3>
        <span id="kpi-categoria">–</span>
      </div>
    </div>

    <div class="charts-box">
      <div class="chart-container">
        <h3>Distribuição por Categoria</h3>
        <canvas id="chart-categorias"></canvas>
      </div>
      <div class="chart-container">
        <h3>Média de Pontuação por Categoria</h3>
        <canvas id="chart-medias"></canvas>
      </div>
      <div class="chart-container">
        <h3>Nível Geral de Sustentabilidade (%)</h3>
        <canvas id="chart-radial"></canvas>
      </div>
    </div>
  </section>

  <!-- USERS CARD -->
  <section id="users-card" class="card">
    <h2>Gerenciar Usuários</h2>
    <table id="users-table">
      <thead>
        <tr><th>Nome</th><th>Email</th><th>Permissão</th><th>Ações</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- REPORTS CARD -->
  <section id="reports-card" class="card">
    <h2>Relatórios Recentes</h2>
    <div class="reports-actions">
      <button id="btn-export-pdf" class="btn-fancy">Exportar PDF</button>
    </div>
    <table id="reports-table">
      <thead>
        <tr><th>Empresa</th><th>Data</th><th>Pontuação</th><th>Categoria</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- Notificação -->
<div class="notificacao" id="notificacao"></div>

<!-- JS -->
<script type="module">
// ---------------- FIREBASE ----------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAe7mU1MyCwrBmJlm89cKM-WHONzeqyU3w",
    authDomain: "projeto-ecotrace.firebaseapp.com",
    projectId: "projeto-ecotrace",
    storageBucket: "projeto-ecotrace.firebasestorage.app",
    messagingSenderId: "528782336744",
    appId: "1:528782336744:web:1f4b1fa4807543ff225f5d",
    measurementId: "G-RTWLGJD188"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------------- ELEMENTOS ----------------
const nomeUsuarioSpan = document.getElementById("nome-usuario");
const logoutBtn = document.getElementById("logout-btn");
let notificou = false;

function mostrarNotificacao(texto){
  const notif = document.getElementById("notificacao");
  notif.textContent = texto;
  notif.classList.add("show");
  setTimeout(()=>notif.classList.remove("show"), 3000);
}

// Troca de cards
const buttons = [
  {btn:'dashboard-home', card:'home-card'},
  {btn:'users-btn', card:'users-card'},
  {btn:'reports-btn', card:'reports-card'},
];
buttons.forEach(item=>{
  const btn=document.getElementById(item.btn);
  const card=document.getElementById(item.card);
  btn.addEventListener("click", ()=>{
    document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
    card.classList.add('active');
  });
});

// Logout
logoutBtn.addEventListener("click", ()=> window.location.href="index.html");

// Carregar dados
onAuthStateChanged(auth, async (user)=>{
  if(user){
    nomeUsuarioSpan.textContent = user.displayName || user.email.split("@")[0];
    if(!notificou){ mostrarNotificacao(`Bem-vindo de volta, ${nomeUsuarioSpan.textContent}!`); notificou=true; }
    await carregarUsuarios();
    await carregarDiagnosticos();
    await carregarRelatorios();
  } else { window.location.href="index.html"; }
});

// ---------------- FUNÇÕES ----------------
async function carregarUsuarios(){
  const tbody = document.querySelector("#users-table tbody");
  tbody.innerHTML="";
  const snapshot = await getDocs(collection(db,"usuarios"));
  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${data.nome||'Sem nome'}</td>
      <td>${data.email}</td>
      <td>${data.role||'user'}</td>
      <td>
        <button class="action-btn admin-btn">${data.role==='admin'?'Rebaixar':'Promover'}</button>
        <button class="action-btn delete-btn">Excluir</button>
      </td>
    `;
    tr.querySelector(".admin-btn").addEventListener("click", async ()=>{
      const novoRole = data.role==='admin'?'user':'admin';
      await updateDoc(doc(db,"usuarios",docSnap.id),{role:novoRole});
      mostrarNotificacao(`Usuário ${data.email} agora é ${novoRole}`);
      carregarUsuarios();
    });
    tr.querySelector(".delete-btn").addEventListener("click", async ()=>{
      if(confirm(`Deseja realmente excluir ${data.email}?`)){
        await deleteDoc(doc(db,"usuarios",docSnap.id));
        mostrarNotificacao(`Usuário ${data.email} excluído`);
        carregarUsuarios();
      }
    });
    tbody.appendChild(tr);
  });
}

async function carregarDiagnosticos(){
  const snapshot = await getDocs(collection(db,"diagnosticos"));
  const categorias = ["Líder","Avançado","Transição","Iniciante","Atenção"];
  const scoresPorCategoria = { "Líder":[], "Avançado":[], "Transição":[], "Iniciante":[], "Atenção":[] };
  let total=0, soma=0;

  snapshot.forEach(docSnap=>{
    const data=docSnap.data();
    const score = data.pontuacao || 0;
    soma += score; total++;
    if(score>=90) scoresPorCategoria["Líder"].push(score);
    else if(score>=75) scoresPorCategoria["Avançado"].push(score);
    else if(score>=60) scoresPorCategoria["Transição"].push(score);
    else if(score>=40) scoresPorCategoria["Iniciante"].push(score);
    else scoresPorCategoria["Atenção"].push(score);
  });

  document.getElementById("kpi-total").textContent = total;
  document.getElementById("kpi-media").textContent = (soma/total).toFixed(1) + "%";
  const categoriaMaisComum = Object.entries(scoresPorCategoria).sort((a,b)=>b[1].length-a[1].length)[0][0];
  document.getElementById("kpi-categoria").textContent = categoriaMaisComum;

  new Chart(document.getElementById("chart-categorias"), {
    type:"pie",
    data:{ labels:Object.keys(scoresPorCategoria), datasets:[{ data:Object.values(scoresPorCategoria).map(a=>a.length), backgroundColor:["#4caf50","#2196f3","#ff9800","#f44336","#9c27b0"] }] }
  });

  new Chart(document.getElementById("chart-medias"), {
    type:"line",
    data:{ labels:Object.keys(scoresPorCategoria), datasets:[{ data:Object.values(scoresPorCategoria).map(a=>a.length? (a.reduce((x,y)=>x+y)/a.length).toFixed(1):0), backgroundColor:"#009f6b" }] },
    options:{ scales:{ y:{ beginAtZero:true, max:100 } } }
  });

  new Chart(document.getElementById("chart-radial"), {
    type:"doughnut",
    data:{ labels:["Nível Global"], datasets:[{ data:[soma/total,100-soma/total], backgroundColor:["#009f6b","#ddd"] }] }
  });
}

async function carregarRelatorios(){
  const tbody = document.querySelector("#reports-table tbody");
  tbody.innerHTML="";
  const snapshot = await getDocs(collection(db,"diagnosticos"));
  snapshot.docs.sort((a,b)=>b.data().data?.seconds-a.data().data?.seconds).forEach(docSnap=>{
    const data=docSnap.data();
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${data.empresa||'-'}</td>
      <td>${data.data? new Date(data.data.seconds*1000).toLocaleDateString():'-'}</td>
      <td>${data.pontuacao}%</td>
      <td>${data.pontuacao>=90?"Líder":data.pontuacao>=75?"Avançado":data.pontuacao>=60?"Transição":data.pontuacao>=40?"Iniciante":"Atenção"}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById("btn-export-pdf").addEventListener("click", ()=> alert("Função de exportar PDF implementável."));
}

document.getElementById("btn-salvar-config").addEventListener("click", ()=>{
  const itens=parseInt(document.getElementById("itens-por-pagina").value);
  mostrarNotificacao(`Configurações salvas: ${itens} itens por página`);
});
</script>
</body>
</html>
