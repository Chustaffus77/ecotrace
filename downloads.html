<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>EcoTrace</title>
  
  <link rel="icon" type="image/png" href="/imagens/image-removebg-preview (1).png">
  <link rel="stylesheet" href="/css/download.css">

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- jsPDF AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

</head>

<body>

  <!-- Overlay -->
  <div id="menu-overlay"></div>

  <!-- Menu lateral -->
  <div id="side-menu">
    <h3 id="nome-usuario">{usu√°rio}</h3>

    <div id="menu-logado" style="display:none;">
      <button id="logout-btn">Fazer Logoff</button>
      <button id="admin-btn" style="display:none;">Dashboard Admin</button>
    </div>

    <div id="menu-deslogado" style="display:none;">
      <a href="login_cadastro.html">Fazer Login</a>
    </div>

    <button id="close-menu">E</button>
  </div>

  <!-- HEADER -->
  <header>
    <a id="eco" href="index.html">
      <img id="logo" src="/imagens/cin.png" alt="ecotrace">
    </a>

    <nav>
      <a id="login" href="forms.html">
        <img class="icone" src="/imagens/log.png" alt="login">
      </a>
      
      <a id="downloads" href="downloads.html">
        <img class="icone" src="/imagens/down.png" alt="downloads">
      </a>

      <a id="perfil">
        <img class="icone" src="/imagens/perfil.png" alt="perfil">
      </a>
    </nav>
  </header>

  <!-- HERO -->
  <section class="downloads-hero">
    <h1>BAIXE O ECOTRACE AGORA</h1>
    <p>Tenha acesso √† nossa plataforma completa para rastreamento de impacto ambiental e sustentabilidade</p>
  </section>

  <!-- DOWNLOADS -->
  <div class="downloads-container">

    <!-- Card Plano -->
    <div class="download-card">
      <div class="download-icon">
        <svg viewBox="0 0 24 24">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
      </div>
      <h3>Seu Plano</h3>
      <p>Baixe aqui o seu plano de Sustentabilidade Industrial, resultado do formul√°rio de Diagn√≥stico EcoTrace.</p>
      <button id="baixar-plano" class="download-btn pulse-animation">
        BAIXE SEU PDF AQUI!
      </button>
    </div>

    <!-- Card Mobile -->
    <div class="download-card">
      <div class="download-icon">
        <svg viewBox="0 0 24 24">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
      </div>
      <h3>Game</h3>
      <p>Forma L√∫dica e Interativa de ensinar e conduzir aprendizado relacionado a Sustentabilidade Industrial.</p>
      <a href="https://zapleee.itch.io/energy-manager" class="download-btn pulse-animation">
        GAMIFICA√á√ÉO AQUI!
      </a>
    </div>

    <!-- Card Documenta√ß√£o -->
    <div class="download-card">
      <div class="download-icon">
        <svg viewBox="0 0 24 24">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
      </div>
      <h3>Documenta√ß√£o</h3>
      <p>Manual completo do Ecotrace, seu desenvolvimento metas e objetivos</p>
      <a href="https://raw.githubusercontent.com//Manual.pdf" download="Manual.pdf">
    BAIXAR MANUAL

    </div>

  </div>

  <!-- FOOTER -->
  <footer>
    ¬© 2025 EcoTrace ‚Äî Tecnologia e Sustentabilidade
  </footer>

  <!-- FIREBASE + SISTEMA -->
  <script type="module">
    import { initializeApp }     from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } 
                                  from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, getDoc }
                                  from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // CONFIG FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyAe7mU1MyCwrBmJlm89cKM-WHONzeqyU3w",
        authDomain: "projeto-ecotrace.firebaseapp.com",
        projectId: "projeto-ecotrace",
        storageBucket: "projeto-ecotrace.firebasestorage.app",
        messagingSenderId: "528782336744",
        appId: "1:528782336744:web:1f4b1fa4807543ff225f5d",
        measurementId: "G-RTWLGJD188"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const sideMenu = document.getElementById("side-menu");
    const overlay = document.getElementById("menu-overlay");
    const perfilBtn = document.getElementById("perfil");
    const closeBtn = document.getElementById("close-menu");

    const logadoDiv = document.getElementById("menu-logado");
    const deslogadoDiv = document.getElementById("menu-deslogado");
    const logoutBtn = document.getElementById("logout-btn");
    const adminBtn = document.getElementById("admin-btn");
    const nomeUsuarioH3 = document.getElementById("nome-usuario");

    function mostrarNotificacao(texto) {
        const notif = document.createElement("div");
        notif.classList.add("notificacao");
        notif.textContent = texto;
        document.body.appendChild(notif);
        setTimeout(() => notif.classList.add("show"), 100);
        setTimeout(() => {
            notif.classList.remove("show");
            setTimeout(() => notif.remove(), 500);
        }, 3500);
    }

    // ================== ESTADO DO USU√ÅRIO ===================
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            logadoDiv.style.display = "flex";
            deslogadoDiv.style.display = "none";

            const nome = user.displayName || user.email.split("@")[0];
            nomeUsuarioH3.textContent = nome;

            // Verificar admin
            const userDoc = await getDoc(doc(db, "usuarios", user.uid));
            const role = userDoc.exists() ? userDoc.data().role : "user";

            if (role === "admin") {
                adminBtn.style.display = "block";
                adminBtn.onclick = () => window.location.href = "dashboard.html";
            }
        } else {
            logadoDiv.style.display = "none";
            deslogadoDiv.style.display = "flex";
            nomeUsuarioH3.textContent = "Visitante";
            adminBtn.style.display = "none";
        }
    });

    // Logout
    if (logoutBtn) {
        logoutBtn.onclick = () => {
            signOut(auth).then(() => location.href = "index.html");
        };
    }

    // MENU LATERAL
    perfilBtn.onclick = () => {
        sideMenu.classList.add("open");
        overlay.classList.add("active");
    };

    closeBtn.onclick = overlay.onclick = () => {
        sideMenu.classList.remove("open");
        overlay.classList.remove("active");
    };

    // ================== GERAR PDF ===================
   
   // ================== GERAR PDF ===================
const btnPlano = document.getElementById("baixar-plano");

btnPlano.addEventListener("click", async () => {
    const user = auth.currentUser;

    if (!user) {
        mostrarNotificacao("Voc√™ precisa estar logado.");
        return;
    }

    const docRef = doc(db, "diagnosticos", user.uid);
    const snapshot = await getDoc(docRef);

    if (!snapshot.exists()) {
        mostrarNotificacao("Nenhum diagn√≥stico encontrado.");
        return;
    }

    const dados = snapshot.data();

    // üî• Recalcular as recomenda√ß√µes priorit√°rias com base no score
    const score = dados.pontuacao;

    const categorias = [
        {
            faixa: [90, 100],
            titulo: "L√≠der em Sustentabilidade",
            descricao: "Sua empresa demonstra excel√™ncia em pr√°ticas sustent√°veis e serve como refer√™ncia mundial.",
            recomenda√ß√µes: [
                { item: "Participe de f√≥runs internacionais", peso: 3 },
                { item: "Busque certifica√ß√µes avan√ßadas (LEED Platinum, ESG+)", peso: 4 },
                { item: "Mentore outras empresas iniciantes", peso: 2 }
            ]
        },
        {
            faixa: [75, 89],
            titulo: "Avan√ßado em Sustentabilidade",
            descricao: "Desempenho s√≥lido, com grande potencial para se tornar refer√™ncia nacional.",
            recomenda√ß√µes: [
                { item: "Implante metas de carbono zero", peso: 4 },
                { item: "Amplie certifica√ß√µes internacionais", peso: 3 },
                { item: "Estabele√ßa parcerias com ONGs ambientais", peso: 2 }
            ]
        },
        {
            faixa: [60, 74],
            titulo: "Em Transi√ß√£o Sustent√°vel",
            descricao: "Bom caminho percorrido, mas ainda h√° pontos estrat√©gicos a evoluir.",
            recomenda√ß√µes: [
                { item: "Monte um comit√™ interno de sustentabilidade", peso: 3 },
                { item: "Estabele√ßa metas mensur√°veis (KPIs ESG)", peso: 4 },
                { item: "Promova treinamentos internos cont√≠nuos", peso: 2 }
            ]
        },
        {
            faixa: [40, 59],
            titulo: "Iniciante",
            descricao: "Sua empresa iniciou a jornada, mas ainda h√° bastante espa√ßo para evolu√ß√£o.",
            recomenda√ß√µes: [
                { item: "Realize auditorias ambientais trimestrais", peso: 3 },
                { item: "Estruture um plano de a√ß√£o sustent√°vel", peso: 4 },
                { item: "Comece com projetos simples e de impacto r√°pido", peso: 2 }
            ]
        },
        {
            faixa: [0, 39],
            titulo: "Aten√ß√£o Imediata",
            descricao: "N√≠veis cr√≠ticos. √â essencial agir rapidamente para evitar preju√≠zos futuros.",
            recomenda√ß√µes: [
                { item: "Contrate consultoria especializada em ESG", peso: 5 },
                { item: "Implemente pol√≠ticas ambientais b√°sicas", peso: 4 },
                { item: "Eduque e conscientize sua equipe", peso: 3 }
            ]
        }
    ];

    const bloco = categorias.find(c => score >= c.faixa[0] && score <= c.faixa[1]);
    const recomendacoesOrdenadas = bloco.recomenda√ß√µes.sort((a, b) => b.peso - a.peso);

    // ==== CRIA√á√ÉO DO PDF ====
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: "mm", format: "a4" });

    // Cabe√ßalho
    pdf.setFillColor(35, 171, 85);
    pdf.rect(0, 0, 210, 25, "F");
    pdf.setTextColor(255, 255, 255);
    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(18);
    pdf.text("Plano de Sustentabilidade ‚Äì EcoTrace", 105, 15, { align: "center" });

    // Info usu√°rio
    pdf.setFontSize(12);
    pdf.setTextColor(0, 0, 0);
    pdf.text(`Usu√°rio: ${dados.nome}`, 10, 35);
    pdf.text(`Empresa: ${dados.empresa}`, 10, 42);
    pdf.text(`Pontua√ß√£o: ${dados.pontuacao}%`, 10, 49);
    pdf.text(`Categoria: ${dados.categoria}`, 10, 56);

    // Tabela de respostas
    const tabela = Object.entries(dados.respostas).map(([k, v]) => ({ Pergunta: k, Resposta: v }));

    pdf.autoTable({
        startY: 65,
        head: [{ Pergunta: "Pergunta", Resposta: "Resposta" }],
        body: tabela,
        theme: "striped",
        headStyles: {
            fillColor: [35, 171, 85],
            textColor: 255,
        },
        styles: { fontSize: 9 }
    });

    // ============================
    // üî• RECOMENDA√á√ïES PRIORIT√ÅRIAS
    // ============================
    let y = pdf.lastAutoTable.finalY + 10;
    pdf.setFontSize(16);
    pdf.text("Recomenda√ß√µes Priorit√°rias", 10, y);
    y += 8;

    recomendacoesOrdenadas.forEach(rec => {
        pdf.setFontSize(12);
        pdf.text(`‚Ä¢ ${rec.item}  (Prioridade: ${rec.peso})`, 12, y);
        y += 8;
    });

    pdf.save("Plano_EcoTrace.pdf");
});



        // ==== CRIA√á√ÉO DO PDF ====
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ unit: "mm", format: "a4" });

        pdf.setFillColor(35, 171, 85);
        pdf.rect(0, 0, 210, 25, "F");

        pdf.setTextColor(255, 255, 255);
        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(18);
        pdf.text("Plano de Sustentabilidade ‚Äì EcoTrace", 105, 15, { align: "center" });

        // Info usu√°rio
        pdf.setFontSize(12);
        pdf.setTextColor(0, 0, 0);
        pdf.text(`Usu√°rio: ${user.displayName || user.email}`, 10, 40);

        // Tabela
        const tabela = Object.entries(dados).map(([k, v]) => ({ Pergunta: k, Resposta: v }));

        pdf.autoTable({
            startY: 50,
            head: [{ Pergunta: "Pergunta", Resposta: "Resposta" }],
            body: tabela,
            theme: "striped",
            headStyles: {
                fillColor: [35, 171, 85],
                textColor: 255,
                fontSize: 12
            },
            styles: { cellPadding: 3, fontSize: 10 },
            columnStyles: {
                Pergunta: { cellWidth: 80 },
                Resposta: { cellWidth: 110 }
            }
        });

        pdf.save("Plano_EcoTrace.pdf");


  </script>
</body>
</html>
